---
title:  "EntityFramework Performance and AutoDetectChanges"
date:   2012-05-07
canonical: http://blog.staticvoid.co.nz/2012/5/7/entityframework_performance_and_autodetectchanges
redirect_from:
  - 2012/5/7/entityframework_performance_and_autodetectchanges
---
<h3>
<span style="font-size: large; font-weight: normal;">What is Auto Detect Changes?</span></h3>
Entity framework has two methods of change detection built into the framework, Instant Notification and Snapshot. Most people seem to use the Snapshot mechanism as it is the easiest to configure and most well known. I will cover the Instant&nbsp;Notification&nbsp;(Proxy Entities)&nbsp;Mechanism&nbsp;in a later post.<br />
<br />
Detect Changes has two purposes:<br />
<br />
<ol>
<li>Snapshot change detection takes a copy of every entity in the system when they are added to the Entity Framework tracking graph. Then as entities change each entity is compared to its snapshot to see any changes. This occurs by calling the <i>DetectChanges </i>method. Whats important to know about <i>DetectChanges </i>is that it has to go through all of your tracked entities each time its called, so the more stuff you have in your context the longer it takes to traverse.</li>
<li>To run 'Fixups' across the context so that navigation properties are updated throughout the context.</li>
</ol>
<br />
For more details on Detect Changes <a href="http://blog.oneunicorn.com/">Arthur Vickers</a> from the Entity Framework team has an awesome&nbsp;<a href="http://blog.oneunicorn.com/2012/03/10/secrets-of-detectchanges-part-1-what-does-detectchanges-do/">blog series on how DetectChanges works</a>&nbsp;in much greater detail.<br />
<br />
What Auto Detect Changes does is plugs into events which happen on the context and calls detect changes as they occur.<br />
<br />
<h3>
<span style="font-size: large; font-weight: normal;">Auto Detect Changes Performance</span></h3>
<div class="separator" style="clear: both; text-align: center;">
<a href="http://4.bp.blogspot.com/-r9GOyxUNQa4/T5t9s6aCitI/AAAAAAAAAOU/jEOGtuhWr_w/s1600/Insert+Comparison.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="http://4.bp.blogspot.com/-r9GOyxUNQa4/T5t9s6aCitI/AAAAAAAAAOU/jEOGtuhWr_w/s640/Insert+Comparison.png" width="640" /></a></div>
<br />
<div class="separator" style="clear: both; text-align: center;">
<a href="http://4.bp.blogspot.com/-JLLtwlX6moE/T5t9ttZiCgI/AAAAAAAAAOY/7RwWwNYOutg/s1600/Insert+Reletive+Performance.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-JLLtwlX6moE/T5t9ttZiCgI/AAAAAAAAAOY/7RwWwNYOutg/s1600/Insert+Reletive+Performance.png" /></a></div>
<br />
<div class="separator" style="clear: both; text-align: center;">
<a href="http://3.bp.blogspot.com/-C7EwuUxFmKM/T5t9ublxuuI/AAAAAAAAAOk/UYGKHrNZC0c/s1600/Update+Comparison.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="398" src="http://3.bp.blogspot.com/-C7EwuUxFmKM/T5t9ublxuuI/AAAAAAAAAOk/UYGKHrNZC0c/s640/Update+Comparison.png" width="640" /></a></div>
<br />
<div class="separator" style="clear: both; text-align: center;">
<a href="http://4.bp.blogspot.com/-ytr6bWJoC6E/T5t9vrWnzlI/AAAAAAAAAOs/8jHwwDoMS-0/s1600/Update+Reletive+Performance.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-ytr6bWJoC6E/T5t9vrWnzlI/AAAAAAAAAOs/8jHwwDoMS-0/s1600/Update+Reletive+Performance.png" /></a><span style="font-size: large;"><br /></span></div>
<div class="separator" style="clear: both; text-align: center;">
<br /></div>
<div class="separator" style="clear: both; text-align: left;">
So wow, lets take a look at those results a little more closely.&nbsp;</div>
<div class="separator" style="clear: both; text-align: left;">
<br /></div>
<div class="separator" style="clear: both; text-align: left;">
From the graphs above you can see that with Auto Detect Changes&nbsp;<b>off&nbsp;</b>the relationship between&nbsp;<i>time&nbsp;</i>and<i>&nbsp;number of items</i>&nbsp;is&nbsp;approximately&nbsp;linear ie O(N), and with Auto Detect Changes&nbsp;<b>on&nbsp;</b>the relationship is quadratic O(N<sup>2</sup>), see&nbsp;<a href="http://math.stackexchange.com/a/138301/30204">here</a>.&nbsp;That means the more items that we modify to our context in Entity Framework the longer it takes to perform each modification.</div>
<div class="separator" style="clear: both; text-align: left;">
<br /></div>
<div class="separator" style="clear: both; text-align: left;">
<span style="font-size: large;">Why is Auto Detect Changes so slow with many items?</span></div>
<div class="separator" style="clear: both; text-align: left;">
As we have touched on earlier whenever we make a change to the context DetectChanges gets called. Detect changes enumerates all attached items</div>
<div class="separator" style="clear: both; text-align: left;">
<br /></div>
<div class="separator" style="clear: both; text-align: left;">
This means that if we are adding 1000 items the first item we add enumerates no items, the second enumerates 1 item and so on. So if we do the math for this we get:</div>
<div class="separator" style="clear: both; text-align: left;">
<br /></div>
<div class="separator" style="clear: both; text-align: center;">
1 + 2 + 3 + ... + 999 + 1000</div>
<div class="separator" style="clear: both; text-align: center;">
<br /></div>
<div class="separator" style="clear: both; text-align: left;">
or:</div>
<div class="separator" style="clear: both; text-align: left;">
<br /></div>
<div class="separator" style="clear: both; text-align: center;">
</div>
<div style="text-align: center;">
<span style="background-color: #fefefe; border-width: 0px; color: #111111; display: inline-block; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 16px; height: 0px; margin: 0px; padding: 0px; position: relative; text-align: left; vertical-align: 0px; white-space: nowrap; width: 13.457em;"><span style="background-color: transparent; border-width: 0px; clip: rect(0.255em 1000em 3.561em -0.501em); left: 0em; margin: 0px; padding: 0px; position: absolute; top: -2.173em; vertical-align: 0px;"><span class="mrow" id="MathJax-Span-423" style="background-color: transparent; border-width: 0px; display: inline; margin: 0px; padding: 0px; position: static; vertical-align: 0px;"><span class="munderover" id="MathJax-Span-424" style="background-color: transparent; border-width: 0px; display: inline; margin: 0px; padding: 0px; position: static; vertical-align: 0px;"><span style="background-color: transparent; border-width: 0px; display: inline-block; height: 0px; margin: 0px; padding: 0px; position: relative; vertical-align: 0px; width: 1.42em;"><span style="background-color: transparent; border-width: 0px; clip: rect(2.087em 1000em 3.857em -0.501em); left: 0em; margin: 0px; padding: 0px; position: absolute; top: -3.222em; vertical-align: 0px;"><span class="mo" id="MathJax-Span-425" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Size2; margin: 0px; padding: 0px; position: static; vertical-align: 0em;">∑</span><span style="background-color: transparent; border-width: 0px; display: inline-block; height: 3.222em; margin: 0px; padding: 0px; position: static; vertical-align: 0px; width: 0px;"></span></span><span style="background-color: transparent; border-width: 0px; clip: rect(1.455em 1000em 2.412em -0.541em); left: 0.123em; margin: 0px; padding: 0px; position: absolute; top: -1.024em; vertical-align: 0px;"><span class="texatom" id="MathJax-Span-426" style="background-color: transparent; border-width: 0px; display: inline; margin: 0px; padding: 0px; position: static; vertical-align: 0px;"><span class="mrow" id="MathJax-Span-427" style="background-color: transparent; border-width: 0px; display: inline; margin: 0px; padding: 0px; position: static; vertical-align: 0px;"><span class="mi" id="MathJax-Span-428" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Math; font-size: 11px; font-style: italic; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">i</span><span class="mo" id="MathJax-Span-429" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; font-size: 11px; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">=</span><span class="mn" id="MathJax-Span-430" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; font-size: 11px; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">0</span></span></span><span style="background-color: transparent; border-width: 0px; display: inline-block; height: 2.111em; margin: 0px; padding: 0px; position: static; vertical-align: 0px; width: 0px;"></span></span><span style="background-color: transparent; border-width: 0px; clip: rect(1.343em 1000em 2.296em -0.534em); left: 0.432em; margin: 0px; padding: 0px; position: absolute; top: -3.261em; vertical-align: 0px;"><span class="mi" id="MathJax-Span-431" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Math; font-size: 11px; font-style: italic; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">N<span style="background-color: transparent; border-width: 0px; display: inline-block; height: 1px; margin: 0px; overflow: hidden; padding: 0px; position: static; vertical-align: 0px; width: 0.06em;"></span></span><span style="background-color: transparent; border-width: 0px; display: inline-block; height: 2.111em; margin: 0px; padding: 0px; position: static; vertical-align: 0px; width: 0px;"></span></span></span></span><span class="mo" id="MathJax-Span-432" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">(</span><span class="mi" id="MathJax-Span-433" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Math; font-style: italic; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">N<span style="background-color: transparent; border-width: 0px; display: inline-block; height: 1px; margin: 0px; overflow: hidden; padding: 0px; position: static; vertical-align: 0px; width: 0.085em;"></span></span><span class="mo" id="MathJax-Span-434" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; margin: 0px; padding: 0px 0px 0px 0.222em; position: static; vertical-align: 0px;">−</span><span class="mi" id="MathJax-Span-435" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Math; font-style: italic; margin: 0px; padding: 0px 0px 0px 0.222em; position: static; vertical-align: 0px;">i</span><span class="mo" id="MathJax-Span-436" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">)</span><span class="mo" id="MathJax-Span-437" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; margin: 0px; padding: 0px 0px 0px 0.278em; position: static; vertical-align: 0px;">=</span><span class="munderover" id="MathJax-Span-438" style="background-color: transparent; border-width: 0px; display: inline; margin: 0px; padding: 0px 0px 0px 0.278em; position: static; vertical-align: 0px;"><span style="background-color: transparent; border-width: 0px; display: inline-block; height: 0px; margin: 0px; padding: 0px; position: relative; vertical-align: 0px; width: 1.42em;"><span style="background-color: transparent; border-width: 0px; clip: rect(2.087em 1000em 3.857em -0.501em); left: 0em; margin: 0px; padding: 0px; position: absolute; top: -3.222em; vertical-align: 0px;"><span class="mo" id="MathJax-Span-439" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Size2; margin: 0px; padding: 0px; position: static; vertical-align: 0em;">∑</span><span style="background-color: transparent; border-width: 0px; display: inline-block; height: 3.222em; margin: 0px; padding: 0px; position: static; vertical-align: 0px; width: 0px;"></span></span><span style="background-color: transparent; border-width: 0px; clip: rect(1.455em 1000em 2.412em -0.541em); left: 0.123em; margin: 0px; padding: 0px; position: absolute; top: -1.024em; vertical-align: 0px;"><span class="texatom" id="MathJax-Span-440" style="background-color: transparent; border-width: 0px; display: inline; margin: 0px; padding: 0px; position: static; vertical-align: 0px;"><span class="mrow" id="MathJax-Span-441" style="background-color: transparent; border-width: 0px; display: inline; margin: 0px; padding: 0px; position: static; vertical-align: 0px;"><span class="mi" id="MathJax-Span-442" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Math; font-size: 11px; font-style: italic; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">i</span><span class="mo" id="MathJax-Span-443" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; font-size: 11px; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">=</span><span class="mn" id="MathJax-Span-444" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; font-size: 11px; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">0</span></span></span><span style="background-color: transparent; border-width: 0px; display: inline-block; height: 2.111em; margin: 0px; padding: 0px; position: static; vertical-align: 0px; width: 0px;"></span></span><span style="background-color: transparent; border-width: 0px; clip: rect(1.343em 1000em 2.296em -0.534em); left: 0.432em; margin: 0px; padding: 0px; position: absolute; top: -3.261em; vertical-align: 0px;"><span class="mi" id="MathJax-Span-445" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Math; font-size: 11px; font-style: italic; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">N<span style="background-color: transparent; border-width: 0px; display: inline-block; height: 1px; margin: 0px; overflow: hidden; padding: 0px; position: static; vertical-align: 0px; width: 0.06em;"></span></span><span style="background-color: transparent; border-width: 0px; display: inline-block; height: 2.111em; margin: 0px; padding: 0px; position: static; vertical-align: 0px; width: 0px;"></span></span></span></span><span class="mi" id="MathJax-Span-446" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Math; font-style: italic; margin: 0px; padding: 0px 0px 0px 0.167em; position: static; vertical-align: 0px;">i</span><span class="mo" id="MathJax-Span-447" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; margin: 0px; padding: 0px 0px 0px 0.278em; position: static; vertical-align: 0px;">=</span><span class="mfrac" id="MathJax-Span-448" style="background-color: transparent; border-width: 0px; display: inline; margin: 0px; padding: 0px 0.12em 0px 0.398em; position: static; vertical-align: 0px;"><span style="background-color: transparent; border-width: 0px; display: inline-block; height: 0px; margin: 0px; padding: 0px; position: relative; vertical-align: 0px; width: 4.194em;"><span style="background-color: transparent; border-width: 0px; clip: rect(1.238em 1000em 2.608em -0.525em); left: 50%; margin: 0px 0px 0px -2.037em; padding: 0px; position: absolute; top: -2.917em; vertical-align: 0px;"><u><span class="mrow" id="MathJax-Span-449" style="background-color: transparent; border-width: 0px; display: inline; margin: 0px; padding: 0px; position: static; vertical-align: 0px;"><span class="mi" id="MathJax-Span-450" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Math; font-style: italic; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">N<span style="background-color: transparent; border-width: 0px; display: inline-block; height: 1px; margin: 0px; overflow: hidden; padding: 0px; position: static; vertical-align: 0px; width: 0.085em;"></span></span><span class="mo" id="MathJax-Span-451" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">(</span><span class="mi" id="MathJax-Span-452" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Math; font-style: italic; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">N<span style="background-color: transparent; border-width: 0px; display: inline-block; height: 1px; margin: 0px; overflow: hidden; padding: 0px; position: static; vertical-align: 0px; width: 0.085em;"></span></span><span class="mo" id="MathJax-Span-453" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; margin: 0px; padding: 0px 0px 0px 0.222em; position: static; vertical-align: 0px;">+</span><span class="mn" id="MathJax-Span-454" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; margin: 0px; padding: 0px 0px 0px 0.222em; position: static; vertical-align: 0px;">1</span><span class="mo" id="MathJax-Span-455" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">)</span></span><span style="background-color: transparent; border-width: 0px; display: inline-block; height: 2.173em; margin: 0px; padding: 0px; position: static; vertical-align: 0px; width: 0px;"></span></u></span><span style="background-color: transparent; border-width: 0px; clip: rect(1.322em 1000em 2.358em -0.506em); left: 50%; margin: 0px 0px 0px -0.247em; padding: 0px; position: absolute; top: -1.487em; vertical-align: 0px;"><span class="mn" id="MathJax-Span-456" style="background-color: transparent; border-width: 0px; display: inline; font-family: MathJax_Main; margin: 0px; padding: 0px; position: static; vertical-align: 0px;">2</span><span style="background-color: transparent; border-width: 0px; display: inline-block; height: 2.173em; margin: 0px; padding: 0px; position: static; vertical-align: 0px; width: 0px;"></span></span><span style="background-color: transparent; border-width: 0px; clip: rect(0.815em 1000em 1.262em -0.556em); left: 0em; margin: 0px; padding: 0px; position: absolute; top: -1.297em; vertical-align: 0px;"><span style="background-color: transparent; border-width: 0px 0px 0px 4.194em; display: inline-block; height: 1.25px; margin: 0px; overflow: hidden; padding: 0px; position: static; vertical-align: 0em; width: 0px;"></span><span style="background-color: transparent; border-width: 0px; display: inline-block; height: 1.077em; margin: 0px; padding: 0px; position: static; vertical-align: 0px; width: 0px;"></span></span></span></span><span class="mspace" id="MathJax-Span-457" style="background-color: transparent; border-width: 0px; display: inline-block; height: 0em; margin: 0px; overflow: hidden; padding: 0px; position: static; vertical-align: 0em; width: 0.278em;"></span></span><span style="background-color: transparent; border-width: 0px; display: inline-block; height: 2.173em; margin: 0px; padding: 0px; position: static; vertical-align: 0px; width: 0px;"></span></span></span><span style="background-color: #fefefe; border-width: 0px 0px 0px 0em; color: #111111; display: inline-block; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 15px; height: 3.304em; margin: 0px; overflow: hidden; padding: 0px; position: static; text-align: left; vertical-align: -1.366em; white-space: nowrap; width: 0px;"></span></div>
<span style="background-color: #fefefe; border-width: 0px 0px 0px 0em; color: #111111; display: inline-block; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 15px; height: 3.304em; margin: 0px; overflow: hidden; padding: 0px; position: static; text-align: left; vertical-align: -1.366em; white-space: nowrap; width: 0px;"></span><br />
<div class="separator" style="clear: both; text-align: left;">
where in this case N is 1000. This function is of the class&nbsp;O(N<sup>2</sup>) which explains why it takes so long to add a large number of items.</div>
<div class="separator" style="clear: both; text-align: left;">
<br /></div>
<div class="separator" style="clear: both; text-align: left;">
<span style="font-size: large;">How do I turn it off?</span></div>
<div class="separator" style="clear: both; text-align: left;">
Fortunately&nbsp;its really easy to turn Auto Detect Changes on and off. Simply use:</div>
<div class="separator" style="clear: both; text-align: left;">
<br /></div>
<div class="separator" style="clear: both; text-align: left;">
&nbsp; &nbsp;&nbsp;<span style="background-color: white; font-family: Consolas; font-size: 9.5pt; line-height: 115%;">context.Configuration.AutoDetectChangesEnabled
= </span><span style="background-color: white; color: blue; font-family: Consolas; font-size: 9.5pt; line-height: 115%;">false</span><span style="background-color: white; font-family: Consolas; font-size: 9.5pt; line-height: 115%;">;</span></div>
<div class="MsoNormal">
<o:p></o:p></div>
<div class="separator" style="clear: both; text-align: left;">
<br /></div>
<div class="separator" style="clear: both; text-align: left;">
But be careful while you have Auto Detect Changes off Entity Framework will not be tracking the changes you have made or fixing up navigation properties. MSDN says this may mean that turning off Auto Detect Changes<i> "can potentially introduce subtle bugs into your application if not used correctly."</i><a href="http://msdn.microsoft.com/en-us/library/gg696177(v=vs.103).aspx"><sup>1</sup></a></div>
<div class="separator" style="clear: both; text-align: left;">
<br /></div>
<div class="separator" style="clear: both; text-align: left;">
Once your done with your bulk changes its worth while manually calling DetectChanges so that you leave the context in an aware state. You can do this as follows:</div>
<div class="separator" style="clear: both; text-align: left;">
<br /></div>
<div class="separator" style="clear: both; text-align: left;">
&nbsp; &nbsp;&nbsp;<span style="background-color: white; font-family: Consolas; font-size: 9.5pt; line-height: 115%;">context.ChangeTracker.DetectChanges();</span></div>
<div class="MsoNormal">
<o:p></o:p></div>
<div class="separator" style="clear: both; text-align: left;">
<br /></div>
<div class="separator" style="clear: both; text-align: left;">
<span style="font-size: large;">Why would I leave it on?</span></div>
<div class="separator" style="clear: both; text-align: left;">
Detect changes is actually really useful in most cases. As you can see from my results when you are dealing with less than 100 items in the context the perfomance impact is&nbsp;negligible. In most cases its much simpler to leave Auto Detect Changes on. As Arthur Vickers aptly puts it<i> "change tracking and the DetectChanges method are a part of the stack where there is a tension between ease-of-use and performance"</i><a href="http://blog.oneunicorn.com/2012/03/10/secrets-of-detectchanges-part-1-what-does-detectchanges-do/"><sup>2</sup></a>.&nbsp;</div>
<div class="separator" style="clear: both; text-align: left;">
<br /></div>
<div class="separator" style="clear: both; text-align: left;">
My general feeling is that if you are doing batch modifications to the database you should be turning Auto Detect Changes off, otherwise it adds complexity for very little gain.</div>
<div class="separator" style="clear: both; text-align: left;">
<br /></div>
<div class="separator" style="clear: both; text-align: left;">
<span style="font-size: large;">Well worth reading</span></div>
<div class="separator" style="clear: both; text-align: left;">
Change tracking is the central and most complex component of Entity Framework, so if you use EF its well worth while to understand some of how it works. Here's some resources that go into a little more detail:</div>
<div class="separator" style="clear: both; text-align: left;">
</div>
<ul>
<li><a href="http://blog.oneunicorn.com/2012/03/10/secrets-of-detectchanges-part-1-what-does-detectchanges-do/">Secrets of DetectChanges Series</a> - Arthur Vickers</li>
<li><a href="http://msdn.microsoft.com/en-us/library/gg696177(v=vs.103).aspx">Change Tracking</a> - MSDN</li>
</ul>
